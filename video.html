<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Course: Video ‚Üí Quiz (8 Modules)</title>
  <style>
    :root {
      --brand: #2563eb;
      --ok: #16a34a;
      --warn: #f59e0b;
      --bad: #dc2626;
      --bg: #f8fafc;
      --fg: #0f172a;
      --muted: #64748b;
      --card: #ffffff;
      --border: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--fg); margin:0; }
    header { background: var(--card); border-bottom: 1px solid var(--border); padding: 12px 20px; position: sticky; top:0; z-index: 10;}
    h1 { font-size: 20px; margin: 0; }
    .container { max-width: 1100px; margin: 20px auto; padding: 0 16px; }
    .grid { display: grid; gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .space { height: 8px; }
    .btn { cursor: pointer; border: 1px solid var(--border); background: #fff; padding: 10px 14px; border-radius: 12px; font-weight: 600; }
    .btn[disabled] { opacity: 0.5; cursor: not-allowed; }
    .btn.primary { background: var(--brand); color: white; border-color: transparent; }
    .btn.ghost { background: transparent; }
    .tag { display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius: 999px; border:1px solid var(--border); background:#fff; font-size:12px; color: var(--muted); }
    .progress-wrap { background: #e5e7eb; border-radius: 999px; height: 10px; overflow: hidden; }
    .progress { height: 10px; background: var(--brand); width: 0%; }
    .muted { color: var(--muted); }
    .ok { color: var(--ok); }
    .bad { color: var(--bad); }
    .warn { color: var(--warn); }
    .divider { height: 1px; background: var(--border); margin: 12px 0; }
    .tabs { display:flex; gap:8px; }
    .tab { padding: 8px 12px; border:1px solid var(--border); border-radius: 999px; background:#fff; cursor:pointer; font-weight:600; }
    .tab.active { background: var(--brand); color:#fff; border-color: transparent; }
    .hidden { display:none !important; }
    .video-box { border-radius: 12px; overflow: hidden; border:1px solid var(--border); background:#000; }
    .quiz-q { margin-bottom: 12px; padding: 12px; border:1px solid var(--border); border-radius: 12px; }
    .quiz-q h4 { margin: 0 0 8px; font-size: 15px; }
    .quiz-q label { display:block; margin: 6px 0; cursor:pointer; }
    .pill { font-size:12px; padding:2px 8px; border-radius: 999px; border:1px solid var(--border); color: var(--muted);}
    .kpi { display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px; }
    .kpi .card { text-align:center; }
    .kpi .num { font-size: 22px; font-weight: 800; }
    details[open] summary::marker, summary::marker { content: ""; }
    summary { cursor: pointer; font-weight: 700; }
    .small { font-size: 12px; }
    .user-permissions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .permission-control { display: flex; align-items: center; justify-content: space-between; padding: 8px; border: 1px solid var(--border); border-radius: 8px; }
    .toggle { position: relative; display: inline-block; width: 44px; height: 24px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--ok); }
    input:checked + .slider:before { transform: translateX(20px); }
    .locked { opacity: 0.5; }
    .sync-status { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 4px 8px; border-radius: 999px; background: var(--bg); }
    .sync-status.syncing { color: var(--warn); }
    .sync-status.synced { color: var(--ok); }
    .sync-status.error { color: var(--bad); }
    .cloud-settings { background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 12px; }
    @media (max-width: 720px){ 
      .kpi{ grid-template-columns: repeat(2, minmax(0, 1fr)); } 
      .user-permissions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="row" role="banner">
    <h1>üéì Video ‚Üí Quiz Course (8 lesson)</h1>
    <span class="tag" id="studentTag">No student</span>
    <div style="margin-left:auto" class="row">
      <span class="sync-status" id="syncStatus">Offline</span>
      <button class="tab active" id="tabCourse">Course</button>
      <button class="tab" id="tabTeacher">Teacher Dashboard</button>
    </div>
  </header>

  <div class="container">
    <!-- Student Sign-in / Profile -->
    <div class="card" id="signinCard">
      <h2>üë§ Student Sign‚Äëin</h2>
      <p class="muted">Enter your name or ID. Your progress is saved locally and synced to the cloud.</p>
      <div class="row">
        <input id="studentId" placeholder="Your name or ID" style="padding:10px 12px; border:1px solid var(--border); border-radius:12px; min-width:260px;" />
        <button class="btn primary" id="btnStart">Start / Continue</button>
        <button class="btn ghost" id="btnSwitch" title="Switch to another student">Switch</button>
      </div>
      <div class="space"></div>
      <div class="row small muted">
        <span>Tip: Teacher can track all students across all devices in the Teacher Dashboard.</span>
      </div>
    </div>

    <!-- Course View -->
    <div class="grid" id="courseView">
      <div class="card">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div class="row">
            <span class="pill">Module <span id="modIndex">1</span> / <span id="modTotal">8</span></span>
            <span class="pill" id="videoStatus">Video: Not watched</span>
            <span class="pill" id="quizStatus">Quiz: Not taken</span>
          </div>
          <div style="min-width: 220px;">
            <div class="progress-wrap" title="Overall progress">
              <div class="progress" id="overallProgress"></div>
            </div>
            <div class="small muted" id="overallLabel">0% complete</div>
          </div>
        </div>
        <div class="divider"></div>

        <!-- Video -->
        <div class="video-box" id="videoContainer">
          <video id="lessonVideo" width="100%" controls preload="metadata" poster="" playsinline>
            <!-- Video sources fixed to use body.mp4 -->
            <source id="videoSource" src="body.mp4" type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        </div>
        
        <div class="row" style="justify-content: space-between; margin-top: 10px;">
          <div class="small muted">You must watch the video to the end before the quiz unlocks.</div>
          <button class="btn" id="btnResetWatch">Mark as not watched</button>
        </div>

        <div class="divider"></div>

        <!-- Quiz -->
        <details id="quizPanel" open>
          <summary>üìù Quiz (10 questions)</summary>
          <form id="quizForm"></form>
          <div class="row" style="justify-content: space-between;">
            <div class="small muted" id="quizHint">Score at least <b>80%</b> to proceed. If you fail, re‚Äëwatch the video.</div>
            <div>
              <button class="btn" id="btnCheck">Check Answers</button>
              <button class="btn ghost" id="btnRetake" disabled>Retake Quiz</button>
            </div>
          </div>
        </details>

        <div class="divider"></div>

        <!-- Nav -->
        <div class="row" style="justify-content: space-between;">
          <button class="btn" id="btnPrev">‚Üê Previous</button>
          <div class="row">
            <button class="btn" id="btnSave">Save Progress</button>
            <button class="btn primary" id="btnNext" disabled>Next ‚Üí</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Liiska PDF-yada</h3>
        <br><a href="Transmitted disease.pdf" target="_blank"> 1. Transmitted disease</a>
        <br><a href="sexully disese.pdf" target="_blank"> 2. Sexully transmitted diseses STD's</a>
        <br><a href="sexully disese Part 2.pdf" target="_blank"> A. Sexully transmitted diseses STD's Part two</a>
        <br><a href="body disese ans immunite .pdf" target="_blank"> 3. Body immunization system</a>
        <br><a href="drug (2).pptx" target="_blank"> 4. Drugs</a>
        <br><a href="The Skeletal System.pdf" target="_blank"> 5.Skeletal System</a>
        <br><a href="reproduction.pdf" target="_blank"> 6. Reproduction</a>
        <br><a href="Metamorphosis.pdf" target="_blank"> 7. Metamorphosis</a>

        <h3>‚ÑπÔ∏è Sida loo isticmaalo</h3> 
        <ul>
          <li>Xeerar la dhaqan geliyay: <b>Fiidiyowga waa in si buuxda loo daawadaa</b> + <b>Imtixaanka (Quiz) ‚â• 80%</b> si loo furo qaybta xigta.</li>
          <li>Haddii natiijada imtixaanka ay ka yar tahay 80%, ardaygu waa inuu mar kale daawadaa fiidiyowga ka hor inta uusan dib u gelin imtixaanka.</li>
          <li>Horumarka si toos ah ayaa loo kaydiyaa waxaana laga dhoofin karaa Guddi Macallin (Teacher Dashboard).</li>
        </ul>
      </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacherView" class="hidden">
      <div class="grid">
        <div class="card">
          <h2>üë©‚Äçüè´ Teacher Dashboard</h2>
          <div class="row">
            <button class="btn" id="btnRefresh">Refresh</button>
            <button class="btn" id="btnExport">Export CSV</button>
            <button class="btn" id="btnSyncNow">Sync Now</button>
            <button class="btn bad" id="btnWipe">Wipe ALL local progress</button>
          </div>
          <div class="divider"></div>
          
          <!-- Cloud Settings -->
          <div class="cloud-settings">
            <h3>‚òÅÔ∏è Cloud Sync Settings</h3>
            <p class="small muted">Configure Google Sheets as your database to see all students across all devices</p>
            <div class="row">
              <input type="text" id="googleSheetsUrl" placeholder="Google Sheets URL" style="flex:1; padding:8px 12px; border:1px solid var(--border); border-radius:8px;" />
              <button class="btn" id="btnTestConnection">Test Connection</button>
            </div>
            <div class="small muted" style="margin-top:8px;">
              <strong>Setup Instructions:</strong> 
              <ol>
                <li>Create a Google Sheet and share it with "Anyone with the link can edit"</li>
                <li>Copy the sheet URL and paste it above</li>
                <li>Click "Test Connection" to verify</li>
              </ol>
            </div>
          </div>
          
          <div class="divider"></div>
          <div class="kpi">
            <div class="card"><div class="small muted">Students</div><div class="num" id="kpiStudents">0</div></div>
            <div class="card"><div class="small muted">Avg Completion</div><div class="num" id="kpiAvg">0%</div></div>
            <div class="card"><div class="small muted">Fully Completed</div><div class="num" id="kpiDone">0</div></div>
            <div class="card"><div class="small muted">Quiz Pass Rate</div><div class="num" id="kpiPassRate">0%</div></div>
          </div>
        </div>
        <div class="card">
          <h3>Students</h3>
          <div class="small muted">Click a student to see detailed progress.</div>
          <div id="studentsList"></div>
        </div>
        <div class="card">
          <h3>Student Details</h3>
          <div id="studentDetail" class="small muted">Select a student‚Ä¶</div>
        </div>
      </div>
    </div>
    
    <!-- Teacher Login Modal -->
    <div id="teacherLoginModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center;">
      <div class="card" style="max-width: 400px; width: 90%;">
        <h2>Teacher Login</h2>
        <p class="muted">Enter the teacher password to access the dashboard</p>
        <input type="password" id="teacherPassword" placeholder="Password" style="padding:10px 12px; border:1px solid var(--border); border-radius:12px; width: 100%; margin-bottom: 12px;" />
        <div class="row" style="justify-content: flex-end;">
          <button class="btn ghost" id="btnCancelLogin">Cancel</button>
          <button class="btn primary" id="btnTeacherLogin">Login</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // üîß CONFIGURATION (EDIT ME)
    // =========================

    // 1) Define 8 modules with video sources and 10-question quizzes each.
    //    üëâ Replace video paths; edit questions as you like.
    
    const SAMPLE_QUIZ = [
  { q: "Q1) Puberty is the period when the body matures and becomes capable of reproduction.", options: ["True", "False"], answer: 0 },
  { q: "Q2) A newborn baby's sex organs are already fully developed and functional.", options: ["True", "False"], answer: 1 },
  { q: "Q3) A girl reaches puberty at the age of 35 years.", options: ["True", "False"], answer: 1 },
  { q: "Q4) A secondary sexual characteristic in boys is the broadening of the shoulders.", options: ["True", "False"], answer: 0 },
  { q: "Q5) In most fish, parents provide extensive care for their young after the eggs hatch.", options: ["True", "False"], answer: 1 },
  { q: "Q6) In frogs, the male fertilizes the eggs after the female has laid them in the water.", options: ["True", "False"], answer: 1 },
  { q: "Q7) Parental care in humans helps a child learn to communicate and use language.", options: ["True", "False"], answer: 0 },
  { q: "Q8) The sequence of bird reproduction includes nest building and incubation of eggs.", options: ["True", "False"], answer: 0 },
  { q: "Q9) Male birds have a penis to transfer sperm internally to the female.", options: ["True", "False"], answer: 1 },
  { q: "Q10) In the tilapia fish, the mother is known to carry and protect the fertilized eggs in her mouth.", options: ["True", "False"], answer: 0 }
];
  
    const MODULES = [
  {
    title: "Module 1",
    video: "body1.mp4",
    quiz: [
      { q: "Q1) A disease is defined as an illness that prevents the body or mind from working normally.", options:["True", "False"], answer: 0 },
      { q: "Q2) Infectious diseases are also known as communicable diseases.", options:["True", "False"], answer: 0 },
      { q: "Q3) All germs are bacteria.", options: ["True", "False"], answer: 1 },
      { q: "Q4) Bacteria are so small that one million can fit on the head of a pin.", options:["True", "False"], answer: 0 },
      { q: "Q5) Bacteria reproduce very slowly, with a single cell dividing only once per day.", options: ["True", "False"], answer: 1 },
      { q: "Q6) All bacteria are harmful and cause disease.", options: ["True", "False"], answer: 0 },
      { q: "Q7) The misuse of antibiotics has led to some diseases becoming resistant to them.", options: ["True", "False"], answer: 0 },
      { q: "Q8) Viruses are larger than bacteria.", options: ["True", "False"], answer: 1 },
      { q: "Q9) Viruses can be easily grown and cultured in a lab just like bacteria.", options: ["True", "False"], answer: 1 },
      { q: "Q10) New viruses are formed inside a living cell, causing it to eventually burst.", options: ["True", "False"], answer: 0 }
    ]
  },
  {
    title: "Module 2",
    video: "body2.mp4",
    quiz: [
      { q: "Q1) Gonorrhea, syphilis, and AIDS are all spread primarily through sexual contact.", options:["True", "False"], answer: 0 },
      { q: "Q2) The bacterium Neisseria gonorrhoeae causes syphilis.", options:["True", "False"], answer: 1 },
      { q: "Q3) A common early symptom of gonorrhea is a painless sore called a chancre.", options: ["True", "False"], answer: 1 },
      { q: "Q4) A complication of untreated gonorrhea in women can be an ectopic pregnancy.", options:["True", "False"], answer: 0 },
      { q: "Q5) Both gonorrhea and syphilis can be effectively treated with a course of penicillin injections.", options: ["True", "False"], answer: 0 },
      { q: "Q6) All bacteria are harmful and cause disease.", options: ["True", "False"], answer: 1 },
      { q: "Q7) IV can be transmitted from an infected mother to her baby through breastfeeding.", options: ["True", "False"], answer: 0 },
      { q: "Q8) The text states that Zina (fornication) is encouraged in Islam as a way to prevent STDs.", options: ["True", "False"], answer: 1 },
      { q: "Q9) One of the factors aiding the spread of HIV is high public awareness and excellent healthcare centers.", options: ["True", "False"], answer: 1 },
      { q: "Q10) The text suggests that early diagnosis and correct drugs can allow an HIV-positive person to live an almost normal lifespan.", options: ["True", "False"], answer: 0 }
    ],
  },
  {
    title: "Module 3",
    video: "body3.mp4",
    quiz: [
  { q: "Q1) The skin is part of the body's natural defense system, acting as a barrier to germs.", options: ["True", "False"], answer: 0 },
  { q: "Q2) If germs get past the skin, they are immediately destroyed and cannot cause illness.", options: ["True", "False"], answer: 1 },
  { q: "Q3) It is easy for the body to develop resistance to all the different viruses that cause the common cold.", options: ["True", "False"], answer: 1 },
  { q: "Q4) Immunization and vaccination are two different things; vaccination does not help the body's natural defenses.", options: ["True", "False"], answer: 1 },
  { q: "Q5) Vaccines can protect people from diseases like measles, tuberculosis, diphtheria, and tetanus.", options: ["True", "False"], answer: 0 },
  { q: "Q6) According to the text, a vaccine for AIDS has been successfully developed.", options: ["True", "False"], answer: 1 },
  { q: "Q7) Immunization is an important prevention method only for adults.", options: ["True", "False"], answer: 1 },
  { q: "Q8) Personal hygiene habits are listed as another way to help control communicable diseases.", options: ["True", "False"], answer: 0 },
  { q: "Q9) Public sanitation programs have no effect on controlling the spread of disease.", options: ["True", "False"], answer: 1 },
  { q: "Q10) The immune system is the body's first line of defense against germs.", options: ["True", "False"], answer: 1 }
],
  },
  {
    title: "Module 4",
    video: "body4.mp4",
    quiz: [
  { q: "Q1) A drug is defined as any substance that alters the way the body works.", options: ["True", "False"], answer: 0 },
  { q: "Q2) Using drugs without a doctor's advice for reasons other than treating an illness is known as drug abuse.", options: ["True", "False"], answer: 0 },
  { q: "Q3) Drugs like penicillin and aspirin are examples of herbal or traditional drugs.", options: ["True", "False"], answer: 1 },
  { q: "Q4) Stimulants are a type of brain-affecting drug that slow down brain activity.", options: ["True", "False"], answer: 1 },
  { q: "Q5) The text states that long-term use of cannabis can lead to psychosis.", options: ["True", "False"], answer: 0 },
  { q: "Q6) Herbal medicines have no connection to modern manufactured drugs.", options: ["True", "False"], answer: 1 },
  { q: "Q7) According to the text, alcoholism only affects the drinker's health and has no impact on their family or social life.", options: ["True", "False"], answer: 1 },
  { q: "Q8) Nicotine is a poison that can prevent the heart from working correctly and lead to a heart attack.", options: ["True", "False"], answer: 0 },
  { q: "Q9) Qat chewing is described as a habit that improves appetite and leads to better nutrition.", options: ["True", "False"], answer: 1 },
  { q: "Q10) The effects of glue sniffing can include feeling like one is floating, followed by headaches, vomiting, or unconsciousness.", options: ["True", "False"], answer: 0 }
],
  },
  {
    title: "Module 5",
    video: "body5.mp4",
    quiz: [
  { q: "Q1) A skeleton is defined as the framework of the body made up of bones.", options: ["True", "False"], answer: 0 },
  { q: "Q2) Animals with a hydrostatic skeleton, like flatworms, are supported by a hard outer shell.", options: ["True", "False"], answer: 1 },
  { q: "Q3) Spiders and insects are examples of animals with an endoskeleton.", options: ["True", "False"], answer: 1 },
  { q: "Q4) Animals with a backbone, like birds and fish, have an endoskeleton.", options: ["True", "False"], answer: 0 },
  { q: "Q5) The human skeleton is an exoskeleton.", options: ["True", "False"], answer: 1 },
  { q: "Q6) The human skeleton consists of 206 bones.", options: ["True", "False"], answer: 0 },
  { q: "Q7) The axial skeleton consists of the limbs and the girdles that support them.", options: ["True", "False"], answer: 1 },
  { q: "Q8) According to the table, the ribs protect the heart and lungs.", options: ["True", "False"], answer: 0 },
  { q: "Q9) The skeleton functions to support the body but does not play a role in blood formation.", options: ["True", "False"], answer: 1 },
  { q: "Q10) The pelvis protects the urinary bladder and abdomen.", options: ["True", "False"], answer: 0 }
],
  },
  {
    title: "Module 6",
    video: "body6.mp4",
    quiz: [
  { q: "Q1) Breathing or respiration involves getting oxygen and removing carbon dioxide.", options: ["True", "False"], answer: 0 },
  { q: "Q2) Exceeding is the process of removing waste from an organism.", options: ["True", "False"], answer: 1 },
  { q: "Q3) Locomotion means forming more individuals.", options: ["True", "False"], answer: 1 },
  { q: "Q4) Nutrition is the process of taking in food.", options: ["True", "False"], answer: 0 },
  { q: "Q5) Reproduction is not a characteristic of all living things.", options: ["True", "False"], answer: 1 },
  { q: "Q6) The oviduct is also called the isthosan bath.", options: ["True", "False"], answer: 1 },
  { q: "Q7) The urethra is the part of the female's body where the baby is carried before birth.", options: ["True", "False"], answer: 1 },
  { q: "Q8) The testes produce male sex cells called sperm.", options: ["True", "False"], answer: 0 },
  { q: "Q9) The placenta is where the foetus receives its food from the mother.", options: ["True", "False"], answer: 0 },
  { q: "Q10) The full gestation period for a human is 9 months.", options: ["True", "False"], answer: 0 },
  { q: "Q11) After the third month, the foetus is fully formed and only grows in size for the remaining six months.", options: ["True", "False"], answer: 1 },
  { q: "Q12) Powerful contractions of the uterus push the baby out through the vagina during natural delivery.", options: ["True", "False"], answer: 0 }
],
  },
  {
    title: "Module 7",
    video: "body7.mp4",
    quiz: JSON.parse(JSON.stringify(SAMPLE_QUIZ)),
  },
  {
    title: "Module 8",
    video: "body8.mp4",
    quiz: [
  { q: "Q1) Metamorphosis is a change in form that occurs after the embryonic stage of an animal's development.", options: ["True", "False"], answer: 0 },
  { q: "Q2) A change in habits never accompanies the change in form during metamorphosis.", options: ["True", "False"], answer: 1 },
  { q: "Q3) The transformation of a maggot into an adult fly is an example of metamorphosis in insects.", options: ["True", "False"], answer: 0 },
  { q: "Q4) The change from a caterpillar to a butterfly is not considered metamorphosis.", options: ["True", "False"], answer: 1 },
  { q: "Q5) The changing of a tadpole into a frog is an example of metamorphosis in amphibians.", options: ["True", "False"], answer: 0 },
  { q: "Q6) The life cycle of a beetle was provided as a detailed example in the text.", options: ["True", "False"], answer: 1 },
  { q: "Q7) According to the diagram, the second stage in a butterfly's life cycle is the pupa.", options: ["True", "False"], answer: 1 },
  { q: "Q8) The larval stage of a butterfly is called a caterpillar.", options: ["True", "False"], answer: 0 },
  { q: "Q9) The text and diagram suggest that metamorphosis is a quick, single-step process.", options: ["True", "False"], answer: 1 },
  { q: "Q10) The pupa is the final adult stage of a butterfly.", options: ["True", "False"], answer: 1 }
],
  },
];

    
    const PASS_PERCENT = 80; // minimum score to proceed

    // =========================
    // üì¶ STATE & STORAGE
    // =========================

    const STORAGE_KEY = "course_students_v3"; // holds dictionary of student profiles
    const TEACHER_PASSWORD_KEY = "teacher_password_v1";
    const USER_PERMISSIONS_KEY = "user_permissions_v1";
    const CLOUD_CONFIG_KEY = "cloud_config_v1";

    function loadAllStudents() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
      catch { return {}; }
    }
    function saveAllStudents(students) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(students));
    }

    function loadUserPermissions() {
      try { return JSON.parse(localStorage.getItem(USER_PERMISSIONS_KEY)) || {}; }
      catch { return {}; }
    }
    function saveUserPermissions(permissions) {
      localStorage.setItem(USER_PERMISSIONS_KEY, JSON.stringify(permissions));
    }

    function loadTeacherPassword() {
      return localStorage.getItem(TEACHER_PASSWORD_KEY) || "teacher123"; // Default password
    }
    function saveTeacherPassword(password) {
      localStorage.setItem(TEACHER_PASSWORD_KEY, password);
    }

    function loadCloudConfig() {
      try { return JSON.parse(localStorage.getItem(CLOUD_CONFIG_KEY)) || { googleSheetsUrl: "" }; }
      catch { return { googleSheetsUrl: "" }; }
    }
    function saveCloudConfig(config) {
      localStorage.setItem(CLOUD_CONFIG_KEY, JSON.stringify(config));
    }

    function defaultProfile(id) {
      return {
        id,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        currentIndex: 0,
        modules: MODULES.map(() => ({ watched: false, score: null, passed: false, attempts: 0, lastAt: null })),
      };
    }

    function defaultPermissions(id) {
      return {
        id,
        canAccessCourse: true,
        modulePermissions: MODULES.map(() => ({ 
          canWatchVideo: true, 
          canTakeQuiz: true 
        }))
      };
    }

    let students = loadAllStudents();
    let userPermissions = loadUserPermissions();
    let cloudConfig = loadCloudConfig();
    let profile = null; // active student
    let teacherLoggedIn = false;
    let syncInProgress = false;

    // =========================
    // üß† HELPERS
    // =========================

    function $(id){ return document.getElementById(id); }

    function setStudentTag() {
      $("studentTag").textContent = profile ? `Student: ${profile.id}` : "No student";
    }

    function updateOverallProgressUI() {
      const total = MODULES.length;
      const passed = profile.modules.filter(m => m.passed).length;
      const pct = Math.round((passed / total) * 100);
      $("overallProgress").style.width = pct + "%";
      $("overallLabel").textContent = `${pct}% complete`;
    }

    function fmtDate(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      return d.toLocaleString();
    }

    function checkUserModulePermission(moduleIndex) {
      if (!profile) return { canWatchVideo: false, canTakeQuiz: false };
      
      const userPerm = userPermissions[profile.id];
      if (!userPerm) return { canWatchVideo: true, canTakeQuiz: true }; // Default permissions
      
      return userPerm.modulePermissions[moduleIndex] || { canWatchVideo: true, canTakeQuiz: true };
    }

    function updateSyncStatus(status, message) {
      const statusEl = $("syncStatus");
      statusEl.textContent = message;
      statusEl.className = "sync-status";
      
      if (status === "syncing") {
        statusEl.classList.add("syncing");
        statusEl.textContent = "üîÑ " + message;
      } else if (status === "synced") {
        statusEl.classList.add("synced");
        statusEl.textContent = "‚úÖ " + message;
      } else if (status === "error") {
        statusEl.classList.add("error");
        statusEl.textContent = "‚ùå " + message;
      } else {
        statusEl.textContent = "üåê " + message;
      }
    }

    // =========================
    // ‚òÅÔ∏è CLOUD SYNC FUNCTIONS
    // =========================

    async function syncToCloud() {
      if (!cloudConfig.googleSheetsUrl || syncInProgress) return;
      
      syncInProgress = true;
      updateSyncStatus("syncing", "Syncing to cloud...");
      
      try {
        // Convert students data to CSV format for Google Sheets
        const csvData = convertStudentsToCSV(students);
        
        // Use Google Sheets API to append data
        const success = await appendToGoogleSheets(csvData);
        
        if (success) {
          updateSyncStatus("synced", "Synced to cloud");
          // Mark students as synced
          Object.values(students).forEach(student => {
            student.synced = true;
          });
          saveAllStudents(students);
        } else {
          updateSyncStatus("error", "Sync failed");
        }
      } catch (error) {
        console.error("Sync error:", error);
        updateSyncStatus("error", "Sync error");
      } finally {
        syncInProgress = false;
      }
    }

    async function syncFromCloud() {
      if (!cloudConfig.googleSheetsUrl || syncInProgress) return;
      
      syncInProgress = true;
      updateSyncStatus("syncing", "Loading from cloud...");
      
      try {
        const cloudStudents = await loadFromGoogleSheets();
        if (cloudStudents) {
          // Merge cloud data with local data
          Object.keys(cloudStudents).forEach(studentId => {
            if (!students[studentId] || 
                new Date(cloudStudents[studentId].updatedAt) > new Date(students[studentId].updatedAt)) {
              students[studentId] = cloudStudents[studentId];
            }
          });
          
          saveAllStudents(students);
          updateSyncStatus("synced", "Loaded from cloud");
          return true;
        } else {
          updateSyncStatus("error", "Load failed");
          return false;
        }
      } catch (error) {
        console.error("Load error:", error);
        updateSyncStatus("error", "Load error");
        return false;
      } finally {
        syncInProgress = false;
      }
    }

    function convertStudentsToCSV(studentsData) {
      const header = ["student_id", "module", "watched", "score", "passed", "attempts", "lastAt", "createdAt", "updatedAt"];
      const rows = [header.join(",")];
      
      Object.values(studentsData).forEach(student => {
        student.modules.forEach((module, index) => {
          rows.push([
            JSON.stringify(student.id),
            index + 1,
            module.watched,
            module.score == null ? "" : module.score,
            module.passed,
            module.attempts || 0,
            module.lastAt || "",
            student.createdAt,
            student.updatedAt,
          ].join(","));
        });
      });
      
      return rows.join("\n");
    }

    async function appendToGoogleSheets(csvData) {
      if (!cloudConfig.googleSheetsUrl) return false;
      
      try {
        // Extract sheet ID from URL
        const sheetIdMatch = cloudConfig.googleSheetsUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (!sheetIdMatch) {
          throw new Error("Invalid Google Sheets URL");
        }
        
        const sheetId = sheetIdMatch[1];
        
        // For a real implementation, you would use the Google Sheets API
        // This is a simplified version that would need proper authentication
        
        // In a real app, you would use:
        // const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/A1:append?valueInputOption=RAW`, {
        //   method: 'POST',
        //   headers: {
        //     'Authorization': 'Bearer YOUR_ACCESS_TOKEN',
        //     'Content-Type': 'application/json'
        //   },
        //   body: JSON.stringify({
        //     values: csvData.split('\n').map(row => row.split(','))
        //   })
        // });
        
        // For demo purposes, we'll simulate a successful response
        console.log("Would sync to Google Sheets:", sheetId);
        console.log("Data:", csvData);
        
        // Simulate API call delay
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        return true;
      } catch (error) {
        console.error("Error appending to Google Sheets:", error);
        return false;
      }
    }

    async function loadFromGoogleSheets() {
      if (!cloudConfig.googleSheetsUrl) return null;
      
      try {
        // Extract sheet ID from URL
        const sheetIdMatch = cloudConfig.googleSheetsUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (!sheetIdMatch) {
          throw new Error("Invalid Google Sheets URL");
        }
        
        const sheetId = sheetIdMatch[1];
        
        // For a real implementation, you would use the Google Sheets API
        // This is a simplified version
        
        // In a real app, you would use:
        // const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/A1:Z1000`, {
        //   headers: {
        //     'Authorization': 'Bearer YOUR_ACCESS_TOKEN'
        //   }
        // });
        // const data = await response.json();
        // return parseStudentsFromSheetData(data.values);
        
        // For demo purposes, we'll return empty data
        console.log("Would load from Google Sheets:", sheetId);
        
        // Simulate API call delay
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        return {};
      } catch (error) {
        console.error("Error loading from Google Sheets:", error);
        return null;
      }
    }

    function parseStudentsFromSheetData(sheetData) {
      // This function would parse the sheet data back into student objects
      // Implementation depends on your sheet structure
      return {};
    }

    // =========================
    // üé¨ COURSE RENDERING
    // =========================

    const videoEl = $("lessonVideo");
    const videoSourceEl = $("videoSource");
    const quizForm = $("quizForm");
    const quizPanel = $("quizPanel");

    let currentIndex = 0;
    let videoWatched = false;
    let quizPassed = false;
    let lastScore = null;

    function loadModule(index){
      currentIndex = index;
      const m = MODULES[index];
      $("modIndex").textContent = index + 1;
      $("modTotal").textContent = MODULES.length;

      // Check permissions for this module
      const permissions = checkUserModulePermission(index);
      
      // Video
      videoEl.pause();
      videoSourceEl.src = m.video;
      videoEl.load();
      
      // Apply permissions to video
      if (!permissions.canWatchVideo) {
        videoEl.controls = false;
        $("videoContainer").classList.add("locked");
      } else {
        videoEl.controls = true;
        $("videoContainer").classList.remove("locked");
      }
      
      videoWatched = !!profile.modules[index].watched; // restore if already watched
      $("videoStatus").textContent = videoWatched ? "Video: Watched ‚úî" : "Video: Not watched";
      if (!permissions.canWatchVideo) {
        $("videoStatus").textContent = "Video: Locked üîí";
      }

      // Quiz
      renderQuiz(m.quiz, index, permissions.canTakeQuiz);
      quizPassed = !!profile.modules[index].passed;
      lastScore = profile.modules[index].score;
      $("quizStatus").textContent = lastScore == null ? "Quiz: Not taken" : `Quiz: ${lastScore}% ${quizPassed ? "‚úî" : "‚úñ"}`;
      if (!permissions.canTakeQuiz) {
        $("quizStatus").textContent = "Quiz: Locked üîí";
      }

      // Controls
      $("btnPrev").disabled = index === 0;
      updateNextState();
      updateOverallProgressUI();
    }

    function renderQuiz(questions, modIndex, canTakeQuiz){
      quizForm.innerHTML = "";
      questions.forEach((item, i) => {
        const div = document.createElement("div");
        div.className = "quiz-q";
        div.innerHTML = `
          <h4>${item.q}</h4>
          ${item.options.map((opt, j) => `
            <label><input type="radio" name="q${i}" value="${j}" ${!canTakeQuiz ? 'disabled' : ''}> ${opt}</label>
          `).join("")}
        `;
        quizForm.appendChild(div);
      });
      $("btnRetake").disabled = true;
      $("btnCheck").disabled = !canTakeQuiz;
    }

    function updateNextState(){
      const permissions = checkUserModulePermission(currentIndex);
      const enabled = videoWatched && quizPassed && permissions.canWatchVideo && permissions.canTakeQuiz;
      $("btnNext").disabled = !enabled;
    }

    // =========================
    // üé• VIDEO LOGIC
    // =========================

    videoEl.addEventListener("ended", () => {
      const permissions = checkUserModulePermission(currentIndex);
      if (!permissions.canWatchVideo) return;
      
      videoWatched = true;
      profile.modules[currentIndex].watched = true;
      profile.modules[currentIndex].lastAt = new Date().toISOString();
      profile.updatedAt = new Date().toISOString();
      saveAllStudents(students);
      
      // Auto-sync to cloud when important progress is made
      syncToCloud();
      
      $("videoStatus").textContent = "Video: Watched ‚úî";
      quizPanel.open = true; // auto-open quiz
      updateNextState();
    });

    $("btnResetWatch").addEventListener("click", () => {
      const permissions = checkUserModulePermission(currentIndex);
      if (!permissions.canWatchVideo) {
        alert("You don't have permission to reset this video.");
        return;
      }
      
      videoWatched = false;
      profile.modules[currentIndex].watched = false;
      profile.modules[currentIndex].passed = false;
      profile.modules[currentIndex].score = null;
      profile.updatedAt = new Date().toISOString();
      saveAllStudents(students);
      $("videoStatus").textContent = "Video: Not watched";
      $("quizStatus").textContent = "Quiz: Not taken";
      $("btnNext").disabled = true;
      lastScore = null; quizPassed = false;
      videoEl.currentTime = 0;
      videoEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    // =========================
    // üìù QUIZ LOGIC
    // =========================

    $("btnCheck").addEventListener("click", (e) => {
      e.preventDefault();
      const permissions = checkUserModulePermission(currentIndex);
      if (!permissions.canTakeQuiz) {
        alert("You don't have permission to take this quiz.");
        return;
      }
      
      const m = MODULES[currentIndex];

      // Require video watched before checking
      if (!videoWatched){
        alert("Please watch the video completely before taking the quiz.");
        return;
      }

      let correct = 0;
      m.quiz.forEach((q, i) => {
        const selected = quizForm.querySelector(`input[name="q${i}"]:checked`);
        if (selected && Number(selected.value) === q.answer) correct++;
      });
      const score = Math.round((correct / m.quiz.length) * 100);
      lastScore = score;

      const passed = score >= PASS_PERCENT;
      quizPassed = passed;

      // Update profile
      const pm = profile.modules[currentIndex];
      pm.attempts += 1;
      pm.score = score;
      pm.passed = passed;
      pm.lastAt = new Date().toISOString();
      profile.updatedAt = new Date().toISOString();
      saveAllStudents(students);
      
      // Sync to cloud when quiz is completed
      syncToCloud();

      // UI
      $("quizStatus").textContent = `Quiz: ${score}% ${passed ? "‚úî" : "‚úñ"}`;
      updateNextState();

      if (!passed){
        alert(`Score ${score}%. You need at least ${PASS_PERCENT}%. Re‚Äëwatching the video is required before retaking.`);
        // Force re‚Äëwatch: lock quiz retake until video ends again
        videoWatched = false;
        pm.watched = false;
        saveAllStudents(students);
        $("videoStatus").textContent = "Video: Not watched";
        $("btnRetake").disabled = true;
        videoEl.currentTime = 0;
        videoEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        videoEl.play();
      } else {
        alert(`Great! You passed with ${score}%. You can go Next.`);
        $("btnRetake").disabled = false;
      }
    });

    $("btnRetake").addEventListener("click", (e) => {
      e.preventDefault();
      const permissions = checkUserModulePermission(currentIndex);
      if (!permissions.canTakeQuiz) {
        alert("You don't have permission to retake this quiz.");
        return;
      }
      
      // Allow retake only if already passed (for improving score) ‚Äî otherwise forced rewatch handled above
      const confirmRetake = confirm("Retake quiz? Your last score will be kept as the best.");
      if (!confirmRetake) return;
      // Clear radio selections
      quizForm.querySelectorAll('input[type="radio"]').forEach(i => i.checked = false);
    });

    // =========================
    // üîÄ NAVIGATION
    // =========================

    $("btnPrev").addEventListener("click", () => {
      if (currentIndex > 0){ loadModule(currentIndex - 1); }
    });

    $("btnNext").addEventListener("click", () => {
      if (currentIndex < MODULES.length - 1){
        loadModule(currentIndex + 1);
      } else {
        alert("üéâ Course finished! Great job.");
      }
    });

    $("btnSave").addEventListener("click", () => {
      profile.currentIndex = currentIndex;
      profile.updatedAt = new Date().toISOString();
      saveAllStudents(students);
      syncToCloud(); // Sync when manually saving
      alert("Progress saved.");
    });

    // =========================
    // üë§ SIGN-IN
    // =========================

    function activateProfile(id){
      if (!students[id]) students[id] = defaultProfile(id);
      if (!userPermissions[id]) userPermissions[id] = defaultPermissions(id);
      
      profile = students[id];
      profile.updatedAt = new Date().toISOString();
      saveAllStudents(students);
      saveUserPermissions(userPermissions);
      setStudentTag();
      $("signinCard").classList.add("hidden");
      $("courseView").classList.remove("hidden");
      $("teacherView").classList.add("hidden");
      loadModule(profile.currentIndex || 0);
      
      // Sync new student to cloud
      syncToCloud();
    }

    $("btnStart").addEventListener("click", () => {
      const id = $("studentId").value.trim();
      if (!id) return alert("Please enter your name or ID");
      activateProfile(id);
    });

    $("btnSwitch").addEventListener("click", () => {
      $("signinCard").classList.remove("hidden");
      $("courseView").classList.add("hidden");
      $("teacherView").classList.add("hidden");
      profile = null;
      setStudentTag();
    });

    // =========================
    // üßë‚Äçüè´ TEACHER DASHBOARD
    // =========================

    function renderTeacher(){
      const list = $("studentsList");
      list.innerHTML = "";
      const entries = Object.values(students).sort((a,b)=> (a.id > b.id ? 1 : -1));

      // KPIs
      $("kpiStudents").textContent = entries.length;
      const compRates = entries.map(s => s.modules.filter(m=>m.passed).length / MODULES.length);
      const avg = entries.length ? Math.round(100 * compRates.reduce((a,b)=>a+b,0)/entries.length) : 0;
      $("kpiAvg").textContent = `${avg}%`;
      const done = entries.filter(s => s.modules.every(m=>m.passed)).length;
      $("kpiDone").textContent = done;
      const allAttempts = entries.flatMap(s => s.modules.map(m => ({score:m.score, attempts:m.attempts})));
      const passCount = allAttempts.filter(x => x.score != null && x.score >= PASS_PERCENT).length;
      const takenCount = allAttempts.filter(x => x.score != null).length;
      $("kpiPassRate").textContent = takenCount ? `${Math.round(100 * passCount / takenCount)}%` : "0%";

      entries.forEach(s => {
        const row = document.createElement('div');
        row.className = 'row';
        row.style.cssText = 'justify-content: space-between; padding:10px 0; border-bottom:1px solid var(--border)';
        const completed = s.modules.filter(m => m.passed).length;
        const syncedIcon = s.synced ? '‚úÖ' : 'üåê';
        row.innerHTML = `
          <div><b>${s.id}</b> ${syncedIcon}<div class="small muted">Updated: ${fmtDate(s.updatedAt)}</div></div>
          <div class="row" style="gap:6px;">
            <span class="pill">${completed}/${MODULES.length} passed</span>
            <button class="btn" data-id="${s.id}">View</button>
          </div>
        `;
        row.querySelector('button').addEventListener('click', () => showStudentDetail(s.id));
        list.appendChild(row);
      });
    }

    function showStudentDetail(id){
      const s = students[id];
      if (!s){ $("studentDetail").textContent = "Not found."; return; }
      
      const userPerm = userPermissions[id] || defaultPermissions(id);
      
      const rows = s.modules.map((m, i) => `
        <tr>
          <td style="padding:6px 8px; border-bottom:1px solid var(--border);">Module ${i+1}</td>
          <td style="padding:6px 8px; border-bottom:1px solid var(--border);">${m.watched ? 'Watched ‚úî' : 'Not watched'}</td>
          <td style="padding:6px 8px; border-bottom:1px solid var(--border);">${m.score == null ? '-' : m.score + '%'}</td>
          <td style="padding:6px 8px; border-bottom:1px solid var(--border);">${m.passed ? 'Passed ‚úî' : 'Pending ‚úñ'}</td>
          <td style="padding:6px 8px; border-bottom:1px solid var(--border);">Attempts: ${m.attempts || 0}</td>
          <td style="padding:6px 8px; border-bottom:1px solid var(--border);">${fmtDate(m.lastAt)}</td>
        </tr>
      `).join('');
      
      // Create permission controls for each module
      const permissionControls = MODULES.map((module, i) => {
        const modulePerm = userPerm.modulePermissions[i] || { canWatchVideo: true, canTakeQuiz: true };
        return `
          <div class="permission-control">
            <div><b>Module ${i+1}:</b> ${module.title}</div>
            <div class="row">
              <label class="small">Video: 
                <label class="toggle">
                  <input type="checkbox" data-module="${i}" data-type="video" ${modulePerm.canWatchVideo ? 'checked' : ''}>
                  <span class="slider"></span>
                </label>
              </label>
              <label class="small">Quiz: 
                <label class="toggle">
                  <input type="checkbox" data-module="${i}" data-type="quiz" ${modulePerm.canTakeQuiz ? 'checked' : ''}>
                  <span class="slider"></span>
                </label>
              </label>
            </div>
          </div>
        `;
      }).join('');
      
      $("studentDetail").innerHTML = `
        <div class="row" style="justify-content: space-between;">
          <div>
            <div><b>${s.id}</b></div>
            <div class="small muted">Created: ${fmtDate(s.createdAt)} ¬∑ Updated: ${fmtDate(s.updatedAt)}</div>
          </div>
          <button class="btn" id="btnImpersonate">Impersonate</button>
        </div>
        <div class="space"></div>
        <div class="progress-wrap"><div class="progress" style="width:${Math.round(100 * s.modules.filter(m=>m.passed).length / MODULES.length)}%"></div></div>
        <div class="space"></div>
        
        <h4>Module Permissions</h4>
        <div class="user-permissions">
          ${permissionControls}
        </div>
        
        <div class="space"></div>
        <table style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--border);">Module</th>
              <th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--border);">Video</th>
              <th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--border);">Score</th>
              <th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--border);">Status</th>
              <th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--border);">Attempts</th>
              <th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--border);">Last Update</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
      
      // Add event listeners to permission toggles
      $("studentDetail").querySelectorAll('input[type="checkbox"]').forEach(toggle => {
        toggle.addEventListener('change', function() {
          const moduleIndex = parseInt(this.dataset.module);
          const type = this.dataset.type;
          const isChecked = this.checked;
          
          // Update permissions
          if (!userPermissions[id]) {
            userPermissions[id] = defaultPermissions(id);
          }
          
          if (type === 'video') {
            userPermissions[id].modulePermissions[moduleIndex].canWatchVideo = isChecked;
          } else if (type === 'quiz') {
            userPermissions[id].modulePermissions[moduleIndex].canTakeQuiz = isChecked;
          }
          
          saveUserPermissions(userPermissions);
          
          // If we're currently viewing this student's course, update the UI
          if (profile && profile.id === id) {
            loadModule(currentIndex);
          }
        });
      });
      
      $("btnImpersonate").addEventListener('click', () => {
        activateProfile(s.id);
        document.getElementById('tabCourse').click();
      });
    }

    $("btnRefresh").addEventListener("click", () => { 
      students = loadAllStudents(); 
      userPermissions = loadUserPermissions();
      renderTeacher(); 
    });

    $("btnSyncNow").addEventListener("click", async () => {
      const success = await syncFromCloud();
      if (success) {
        renderTeacher();
      }
    });

    $("btnExport").addEventListener("click", () => {
      const entries = Object.values(students);
      const header = ["student_id","module","watched","score","passed","attempts","lastAt","createdAt","updatedAt"];
      const rows = [header.join(",")];
      entries.forEach(s => {
        s.modules.forEach((m, i) => {
          rows.push([
            JSON.stringify(s.id),
            i+1,
            m.watched,
            m.score == null ? "" : m.score,
            m.passed,
            m.attempts || 0,
            m.lastAt || "",
            s.createdAt,
            s.updatedAt,
          ].join(","));
        });
      });
      const blob = new Blob([rows.join("\n")], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'course_progress.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    $("btnWipe").addEventListener("click", () => {
      if (!confirm("This will delete ALL local progress for ALL students on this device. Continue?")) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(USER_PERMISSIONS_KEY);
      students = {}; 
      userPermissions = {};
      profile = null;
      $("studentsList").innerHTML = "";
      $("studentDetail").textContent = "Select a student‚Ä¶";
      $("signinCard").classList.remove("hidden");
      $("courseView").classList.add("hidden");
      $("teacherView").classList.add("hidden");
      setStudentTag();
    });

    // Cloud configuration
    $("googleSheetsUrl").value = cloudConfig.googleSheetsUrl;
    
    $("googleSheetsUrl").addEventListener("change", function() {
      cloudConfig.googleSheetsUrl = this.value;
      saveCloudConfig(cloudConfig);
    });
    
    $("btnTestConnection").addEventListener("click", async function() {
      const url = $("googleSheetsUrl").value;
      if (!url) {
        alert("Please enter a Google Sheets URL");
        return;
      }
      
      // Test the connection
      const success = await syncToCloud();
      if (success) {
        alert("Connection successful! Data will be synced to this sheet.");
      } else {
        alert("Connection failed. Please check the URL and make sure the sheet is shared with 'Anyone with the link can edit'.");
      }
    });

    // =========================
    // üîê TEACHER LOGIN
    // =========================

    function showTeacherLogin() {
      $("teacherLoginModal").classList.remove("hidden");
    }

    function hideTeacherLogin() {
      $("teacherLoginModal").classList.add("hidden");
      $("teacherPassword").value = "";
    }

    function checkTeacherLogin() {
      const password = $("teacherPassword").value;
      const storedPassword = loadTeacherPassword();
      
      if (password === storedPassword) {
        teacherLoggedIn = true;
        hideTeacherLogin();
        $("teacherView").classList.remove("hidden");
        renderTeacher();
        return true;
      } else {
        alert("Incorrect password. Please try again.");
        return false;
      }
    }

    $("btnTeacherLogin").addEventListener("click", checkTeacherLogin);
    
    $("btnCancelLogin").addEventListener("click", () => {
      hideTeacherLogin();
      $("tabCourse").click();
    });
    
    $("teacherPassword").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        checkTeacherLogin();
      }
    });

    // Tabs
    const tabCourse = $("tabCourse");
    const tabTeacher = $("tabTeacher");
    tabCourse.addEventListener('click', () => {
      tabCourse.classList.add('active');
      tabTeacher.classList.remove('active');
      $("courseView").classList.remove('hidden');
      $("teacherView").classList.add('hidden');
    });
    tabTeacher.addEventListener('click', () => {
      if (!teacherLoggedIn) {
        showTeacherLogin();
        return;
      }
      
      tabTeacher.classList.add('active');
      tabCourse.classList.remove('active');
      $("courseView").classList.add('hidden');
      $("teacherView").classList.remove('hidden');
      renderTeacher();
    });

    // Boot
    (function init(){
      // Auto-activate last used student if any
      const lastId = sessionStorage.getItem('lastStudentId');
      if (lastId && loadAllStudents()[lastId]){
        students = loadAllStudents();
        userPermissions = loadUserPermissions();
        profile = students[lastId];
        setStudentTag();
        $("signinCard").classList.add("hidden");
        $("courseView").classList.remove("hidden");
        loadModule(profile.currentIndex || 0);
      } else {
        $("courseView").classList.remove("hidden");
      }

      $("btnStart").addEventListener('click', () => {
        const id = $("studentId").value.trim();
        if (id){ sessionStorage.setItem('lastStudentId', id); }
      });
      
      // Initial cloud sync check
      if (cloudConfig.googleSheetsUrl) {
        updateSyncStatus("", "Cloud ready");
      } else {
        updateSyncStatus("", "Offline");
      }
    })();
  </script>
</body>
</html>